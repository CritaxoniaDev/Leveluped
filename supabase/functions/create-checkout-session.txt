import Stripe from 'https://esm.sh/stripe@13.0.0'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.38.4'

const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization, x-client-info, apikey',
}

Deno.serve(async (req) => {
    if (req.method === 'OPTIONS') {
        return new Response(null, { status: 204, headers: corsHeaders })
    }

    if (req.method !== 'POST') {
        return new Response(
            JSON.stringify({ success: false, error: 'Method not allowed' }),
            { status: 405, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
        )
    }

    try {
        const stripeKey = Deno.env.get('STRIPE_SECRET_KEY')
        const supabaseUrl = Deno.env.get('SUPABASE_URL')
        const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')

        if (!stripeKey || !supabaseUrl || !supabaseKey) {
            throw new Error('Missing environment configuration')
        }

        const stripe = new Stripe(stripeKey)
        const supabase = createClient(supabaseUrl, supabaseKey)

        const { userId, customerId, priceId, successUrl, cancelUrl } = await req.json()

        if (!userId || !customerId || !priceId || !successUrl || !cancelUrl) {
            console.error('Missing required fields:', { userId, customerId, priceId, successUrl, cancelUrl })
            throw new Error('Missing required fields')
        }

        console.log('Fetching product for priceId:', priceId)

        // Fetch product details using stripe_price_id
        const { data: product, error: productError } = await supabase
            .from('stripe_products')
            .select('id, coins, amount, currency, name')
            .eq('stripe_price_id', priceId)
            .single()

        if (productError) {
            throw new Error('Product not found for this price')
        }

        if (!product) {
            throw new Error('Product data is empty')
        }

        console.log('Product found:', { productId: product.id, coins: product.coins, name: product.name })

        // Create checkout session with productId in metadata
        const session = await stripe.checkout.sessions.create({
            customer: customerId,
            payment_method_types: ['card'],
            line_items: [{
                price: priceId,
                quantity: 1
            }],
            mode: 'payment',
            success_url: successUrl,
            cancel_url: cancelUrl,
            metadata: {
                userId,
                productId: product.id  // Store the UUID here
            }
        })

        return new Response(
            JSON.stringify({ 
                success: true,
                sessionId: session.id,
                checkoutUrl: session.url
            }),
            {
                status: 200,
                headers: { 'Content-Type': 'application/json', ...corsHeaders }
            }
        )
    } catch (error: any) {
        return new Response(
            JSON.stringify({ 
                success: false,
                error: error.message
            }),
            {
                status: 400,
                headers: { 'Content-Type': 'application/json', ...corsHeaders }
            }
        )
    }
})