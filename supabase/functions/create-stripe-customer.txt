import Stripe from 'https://esm.sh/stripe@13.0.0'

const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization, x-client-info, apikey',
}

Deno.serve(async (req) => {
    if (req.method === 'OPTIONS') {
        return new Response(null, { 
            status: 204,
            headers: corsHeaders 
        })
    }

    if (req.method !== 'POST') {
        return new Response(
            JSON.stringify({ success: false, error: 'Method not allowed' }),
            { 
                status: 405, 
                headers: { 'Content-Type': 'application/json', ...corsHeaders } 
            }
        )
    }

    try {
        console.log('=== Request received ===')
        
        const stripeKey = Deno.env.get('STRIPE_SECRET_KEY')
        console.log('STRIPE_SECRET_KEY set:', !!stripeKey)
        
        if (!stripeKey) {
            throw new Error('STRIPE_SECRET_KEY not configured')
        }

        const body = await req.json()
        console.log('Request body:', body)
        
        const { userId, email, name } = body

        if (!userId) {
            throw new Error('Missing userId')
        }
        if (!email) {
            throw new Error('Missing email')
        }

        console.log('Creating Stripe customer:', { userId, email, name })

        const stripe = new Stripe(stripeKey)
        const customer = await stripe.customers.create({
            email,
            name: name || 'Customer',
            metadata: { userId }
        })

        console.log('Customer created:', customer.id)

        return new Response(
            JSON.stringify({ 
                success: true,
                customerId: customer.id
            }),
            {
                status: 200,
                headers: { 'Content-Type': 'application/json', ...corsHeaders }
            }
        )
    } catch (error: any) {
        console.error('Error caught:', error.message)
        console.error('Stack:', error.stack)
        
        return new Response(
            JSON.stringify({ 
                success: false,
                error: error.message
            }),
            {
                status: 400,
                headers: { 'Content-Type': 'application/json', ...corsHeaders }
            }
        )
    }
})